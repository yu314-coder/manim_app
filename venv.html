<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Environment Manager - Manim Studio Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cascadia Code', 'Consolas', 'Monaco', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: #252526;
            padding: 15px 20px;
            border-bottom: 1px solid #3c3c3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
        }

        .venv-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            background: #37373d;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #464647;
            color: #4ec9b0;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: #0e639c;
            color: white;
        }

        .btn-primary:hover {
            background: #1177bb;
        }

        .btn-secondary {
            background: #3c3c3c;
            color: #cccccc;
        }

        .btn-secondary:hover {
            background: #4c4c4c;
        }

        .btn-success {
            background: #16825d;
            color: white;
        }

        .btn-success:hover {
            background: #1e9973;
        }

        .btn-danger {
            background: #c5282f;
            color: white;
        }

        .btn-danger:hover {
            background: #d73e46;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: #252526;
            border-right: 1px solid #3c3c3c;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #cccccc;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .env-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .env-item {
            background: #37373d;
            border: 1px solid #464647;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .env-item:hover {
            background: #404041;
            border-color: #569cd6;
        }

        .env-item.active {
            background: #0e639c;
            border-color: #1177bb;
            color: white;
        }

        .env-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .env-details {
            font-size: 11px;
            color: #969696;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .env-item.active .env-details {
            color: #e0e0e0;
        }

        .env-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 10px;
        }

        .create-env-form {
            background: #37373d;
            border: 1px solid #464647;
            border-radius: 6px;
            padding: 15px;
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 12px;
            color: #cccccc;
            margin-bottom: 6px;
        }

        .form-input, .form-select {
            width: 100%;
            background: #2d2d30;
            border: 1px solid #464647;
            border-radius: 4px;
            padding: 8px;
            color: #d4d4d4;
            font-size: 12px;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            border-color: #569cd6;
            outline: none;
        }

        /* Main Panel */
        .main-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tabs */
        .tabs {
            background: #2d2d30;
            border-bottom: 1px solid #3c3c3c;
            padding: 0 20px;
            display: flex;
            gap: 0;
        }

        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #969696;
            cursor: pointer;
            font-size: 12px;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab.active {
            color: #d4d4d4;
            border-bottom-color: #569cd6;
        }

        .tab:hover {
            color: #d4d4d4;
        }

        /* Tab Content */
        .tab-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #969696;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid #3c3c3c;
            border-top: 2px solid #569cd6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Packages Grid */
        .packages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .package-item {
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            padding: 12px;
            transition: all 0.2s;
        }

        .package-item:hover {
            background: #2d2d30;
            border-color: #569cd6;
        }

        .package-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            color: #4ec9b0;
        }

        .package-version {
            font-size: 11px;
            color: #969696;
            margin-bottom: 8px;
        }

        .package-actions {
            display: flex;
            gap: 4px;
        }

        /* Health Check */
        .health-grid {
            display: grid;
            gap: 12px;
        }

        .health-item {
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f44747;
        }

        .health-status.pass {
            background: #4ec9b0;
        }

        .health-status.warn {
            background: #dcdcaa;
        }

        .health-info {
            flex: 1;
        }

        .health-name {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .health-desc {
            font-size: 11px;
            color: #969696;
        }

        /* Terminal Log */
        .terminal-log {
            background: #1e1e1e;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Cascadia Code', 'Consolas', monospace;
        }

        .log-entry {
            margin-bottom: 4px;
            font-size: 12px;
            line-height: 1.4;
        }

        .log-info {
            color: #569cd6;
        }

        .log-success {
            color: #4ec9b0;
        }

        .log-warning {
            color: #dcdcaa;
        }

        .log-error {
            color: #f44747;
        }

        /* Install Section */
        .install-section {
            background: #252526;
            border: 1px solid #3c3c3c;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .install-form {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .install-input {
            flex: 1;
            background: #2d2d30;
            border: 1px solid #464647;
            border-radius: 4px;
            padding: 8px;
            color: #d4d4d4;
            font-size: 12px;
            font-family: inherit;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2d2d30;
        }

        ::-webkit-scrollbar-thumb {
            background: #464647;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #569cd6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="title">
                <span>🐍</span>
                <span>Virtual Environment Manager</span>
            </div>
            
            <div class="venv-status" id="current-env-status">
                <span>⚪</span>
                <span id="env-status-text">Ready</span>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-success" onclick="refreshEnvironments()">🔄 Refresh</button>
                <button class="btn btn-primary" onclick="autoSetup()">⚡ Auto Setup</button>
                <button class="btn btn-secondary" onclick="window.close()">✖ Close</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Current Environment -->
                <div class="section">
                    <div class="section-title">Current Environment</div>
                    <div id="current-env-info">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading environment info...
                        </div>
                    </div>
                </div>

                <!-- Available Environments -->
                <div class="section">
                    <div class="section-title">Available Environments</div>
                    <div class="env-list" id="env-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            Scanning environments...
                        </div>
                    </div>
                </div>

                <!-- Create New Environment -->
                <div class="section">
                    <div class="section-title">Create Environment</div>
                    <div class="create-env-form">
                        <div class="form-group">
                            <label class="form-label">Environment Name</label>
                            <input type="text" class="form-input" id="new-env-name" placeholder="my_environment" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Python Version</label>
                            <select class="form-select" id="python-version">
                                <option value="3.11">Python 3.11</option>
                                <option value="3.10">Python 3.10</option>
                                <option value="3.9">Python 3.9</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="createEnvironment()" style="width: 100%;">
                            Create Environment
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Panel -->
            <div class="main-panel">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('packages')">Packages</button>
                    <button class="tab" onclick="switchTab('environment')">Environment Info</button>
                    <button class="tab" onclick="switchTab('health')">Health Check</button>
                    <button class="tab" onclick="switchTab('logs')">Logs</button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Packages Tab -->
                    <div id="packages-tab" class="tab-pane active">
                        <div class="install-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="section-title">Install Package</div>
                                <button class="btn btn-secondary" onclick="refreshPackages()" style="font-size: 11px; padding: 4px 8px;">🔄 Refresh</button>
                            </div>
                            <div class="install-form">
                                <input type="text" class="install-input" id="install-input" placeholder="Package name (e.g., numpy, matplotlib)" />
                                <button class="btn btn-success" onclick="installPackage()">Install</button>
                            </div>
                            <div style="font-size: 11px; color: #969696;">
                                Popular packages: manim, numpy, matplotlib, pillow, opencv-python
                            </div>
                        </div>

                        <div class="section-title">Installed Packages</div>
                        <div class="packages-grid" id="packages-grid">
                            <div class="package-item">
                                <div class="package-name">Loading packages...</div>
                                <div class="package-version">Please wait</div>
                                <div class="package-actions">
                                    <div class="spinner" style="width: 16px; height: 16px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Environment Info Tab -->
                    <div id="environment-tab" class="tab-pane">
                        <div class="env-info-grid" id="env-info-grid">
                            <div class="health-item">
                                <div class="health-status pass"></div>
                                <div class="health-info">
                                    <div class="health-name">Environment Path</div>
                                    <div class="health-desc">~/.manim_studio/venvs/manim_studio_default</div>
                                </div>
                            </div>
                            <div class="health-item">
                                <div class="health-status pass"></div>
                                <div class="health-info">
                                    <div class="health-name">Python Version</div>
                                    <div class="health-desc">Python 3.11.0</div>
                                </div>
                            </div>
                            <div class="health-item">
                                <div class="health-status pass"></div>
                                <div class="health-info">
                                    <div class="health-name">Pip Version</div>
                                    <div class="health-desc">pip 23.2.1</div>
                                </div>
                            </div>
                            <div class="health-item">
                                <div class="health-status pass"></div>
                                <div class="health-info">
                                    <div class="health-name">Installed Packages</div>
                                    <div class="health-desc">25 packages installed</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Health Check Tab -->
                    <div id="health-tab" class="tab-pane">
                        <div class="health-check" id="health-check">
                            <div class="health-grid">
                                <div class="health-item">
                                    <div class="health-status pass"></div>
                                    <div class="health-info">
                                        <div class="health-name">Python Installation</div>
                                        <div class="health-desc">Python is properly installed and accessible</div>
                                    </div>
                                </div>
                                <div class="health-item">
                                    <div class="health-status pass"></div>
                                    <div class="health-info">
                                        <div class="health-name">Manim Installation</div>
                                        <div class="health-desc">Manim is installed and working correctly</div>
                                    </div>
                                </div>
                                <div class="health-item">
                                    <div class="health-status pass"></div>
                                    <div class="health-info">
                                        <div class="health-name">Dependencies</div>
                                        <div class="health-desc">All required dependencies are satisfied</div>
                                    </div>
                                </div>
                                <div class="health-item">
                                    <div class="health-status warn"></div>
                                    <div class="health-info">
                                        <div class="health-name">LaTeX Installation</div>
                                        <div class="health-desc">LaTeX not found - some text rendering may be limited</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Logs Tab -->
                    <div id="logs-tab" class="tab-pane">
                        <div class="terminal-log" id="terminal-log">
                            <div class="log-entry log-info">Virtual Environment Manager initialized</div>
                            <div class="log-entry log-info">Ready to manage Python packages and environments</div>
                            <div class="log-entry log-info">Switch to 'Packages' tab to view installed packages</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentEnvironment = null;
        let availableEnvironments = [];
        let installedPackages = [];

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🐍 Virtual Environment Manager loaded');
            initializeVenvManager();
        });

        // Listen for electronAPI events if available
        if (window.electronAPI && window.electronAPI.onVenvData) {
            window.electronAPI.onVenvData((venvData) => {
                console.log('Received venv data:', venvData);
                if (venvData.packages) {
                    installedPackages = venvData.packages;
                    renderPackages();
                    addLog(`Loaded ${installedPackages.length} packages from backend`, 'success');
                }
                if (venvData.currentEnv) {
                    currentEnvironment = venvData.currentEnv;
                    updateEnvironmentStatus();
                }
            });
        }

        // Initialize the environment manager
        async function initializeVenvManager() {
            addLog('Initializing Virtual Environment Manager...', 'info');
            
            try {
                // Check current environment and load packages
                await checkCurrentEnvironment();
                await loadAvailableEnvironments();
                
                // Force load packages regardless of environment status
                addLog('Attempting to load packages...', 'info');
                await loadPackages();
                
                await runHealthCheck();
                
                addLog('Virtual Environment Manager initialized successfully', 'success');
            } catch (error) {
                addLog(`Initialization failed: ${error.message}`, 'error');
                // Still try to load packages even if initialization had issues
                addLog('Attempting fallback package detection...', 'warning');
                await loadPackages();
            }
        }

        // Check current environment
        async function checkCurrentEnvironment() {
            try {
                if (window.electronAPI && window.electronAPI.getPythonInfo) {
                    const result = await window.electronAPI.getPythonInfo();
                    if (result.success) {
                        if (result.venvExists && result.venvPath) {
                            const venvName = result.venvPath.split(/[/\\]/).pop();
                            currentEnvironment = {
                                name: venvName,
                                path: result.venvPath,
                                pythonPath: result.pythonPath,
                                active: true
                            };
                            addLog(`Found virtual environment: ${venvName}`, 'success');
                        } else if (result.pythonPath) {
                            currentEnvironment = {
                                name: 'system_python',
                                path: 'System Python Installation',
                                pythonPath: result.pythonPath,
                                active: true
                            };
                            addLog('Using system Python - no virtual environment detected', 'warning');
                        } else {
                            addLog('No Python installation found', 'error');
                            currentEnvironment = null;
                        }
                        updateEnvironmentStatus();
                        return;
                    }
                }
                
                // If API doesn't work, try alternative methods
                if (window.electronAPI && window.electronAPI.executeCommand) {
                    try {
                        // Try to detect virtual environment
                        const venvResult = await window.electronAPI.executeCommand('echo $VIRTUAL_ENV || echo %VIRTUAL_ENV%');
                        if (venvResult.success && venvResult.output && venvResult.output.trim() && !venvResult.output.includes('VIRTUAL_ENV')) {
                            const venvPath = venvResult.output.trim();
                            const venvName = venvPath.split(/[/\\]/).pop();
                            currentEnvironment = {
                                name: venvName,
                                path: venvPath,
                                pythonPath: venvPath + (process.platform === 'win32' ? '\\Scripts\\python.exe' : '/bin/python'),
                                active: true
                            };
                            addLog(`Detected virtual environment: ${venvName}`, 'success');
                            updateEnvironmentStatus();
                            return;
                        }
                    } catch (venvError) {
                        addLog('Virtual environment detection failed', 'warning');
                    }
                }
                
                // Last resort - no environment found
                addLog('No virtual environment detected - install packages manually', 'warning');
                currentEnvironment = null;
                updateEnvironmentStatus();
                
            } catch (error) {
                addLog(`Error checking environment: ${error.message}`, 'error');
                currentEnvironment = null;
                updateEnvironmentStatus();
            }
        }

        // Load available environments
        async function loadAvailableEnvironments() {
            try {
                if (window.electronAPI && window.electronAPI.listVirtualEnvironments) {
                    const result = await window.electronAPI.listVirtualEnvironments();
                    if (result.success) {
                        availableEnvironments = result.environments;
                        updateEnvironmentList();
                        addLog(`Found ${availableEnvironments.length} environments`, 'info');
                    }
                } else {
                    // Fallback
                    availableEnvironments = currentEnvironment ? [currentEnvironment] : [];
                    updateEnvironmentList();
                }
            } catch (error) {
                addLog(`Error loading environments: ${error.message}`, 'error');
                availableEnvironments = [];
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            addLog(`Switched to ${tabName} tab`, 'info');
            
            // Force refresh data when switching to packages tab
            if (tabName === 'packages') {
                addLog('Packages tab activated - checking package display...', 'info');
                
                // Check current state
                const packagesGrid = document.getElementById('packages-grid');
                if (packagesGrid) {
                    addLog(`Current packages grid content: ${packagesGrid.children.length} items`, 'info');
                    
                    // If no packages are shown or showing loading, force refresh
                    if (installedPackages.length === 0 || packagesGrid.innerHTML.includes('Loading packages')) {
                        addLog('Forcing package reload for tab switch...', 'info');
                        setTimeout(async () => {
                            await loadPackages();
                        }, 100);
                    } else {
                        addLog(`${installedPackages.length} packages already loaded`, 'success');
                        // Just re-render in case display got corrupted
                        renderPackages();
                    }
                }
            }
        }

        // Environment management
        function updateEnvironmentStatus() {
            const statusElement = document.getElementById('env-status-text');
            if (statusElement) {
                if (currentEnvironment) {
                    statusElement.textContent = `Active: ${currentEnvironment.name}`;
                } else {
                    statusElement.textContent = 'No environment active';
                }
            }
            updateCurrentEnvironmentInfo();
        }

        function updateCurrentEnvironmentInfo() {
            const container = document.getElementById('current-env-info');
            
            if (!currentEnvironment) {
                container.innerHTML = `
                    <div class="env-item">
                        <div class="env-name">❌ No Environment Found</div>
                        <div class="env-details">
                            <div>No Python virtual environment detected</div>
                            <div>Create or activate an environment first</div>
                        </div>
                        <div class="env-actions">
                            <button class="btn btn-small btn-primary" onclick="autoSetup()">Auto Setup</button>
                        </div>
                    </div>
                `;
                return;
            }

            let statusIcon = '✅';
            let statusText = 'Virtual Environment';
            
            if (currentEnvironment.name === 'system_python') {
                statusIcon = '🐍';
                statusText = 'System Python (No VEnv)';
            }

            container.innerHTML = `
                <div class="env-item active">
                    <div class="env-name">${statusIcon} ${currentEnvironment.name}</div>
                    <div class="env-details">
                        <div>Type: ${statusText}</div>
                        <div>Path: ${currentEnvironment.path}</div>
                        <div>Packages: ${installedPackages.length} detected</div>
                    </div>
                    <div class="env-actions">
                        <button class="btn btn-small btn-secondary" onclick="refreshPackages()">Refresh</button>
                    </div>
                </div>
            `;
        }

        function updateEnvironmentList() {
            const envList = document.getElementById('env-list');
            
            if (availableEnvironments.length === 0) {
                envList.innerHTML = `
                    <div class="env-item">
                        <div class="env-name">No environments found</div>
                        <div class="env-details">
                            <div>Create a new environment to get started</div>
                        </div>
                    </div>
                `;
                return;
            }

            envList.innerHTML = availableEnvironments.map(env => `
                <div class="env-item ${env.active ? 'active' : ''}" onclick="activateEnvironment('${env.name}')">
                    <div class="env-name">${env.name}</div>
                    <div class="env-details">
                        <div>Path: ${env.path}</div>
                        <div>Status: ${env.active ? '✅ Active' : '⚪ Available'}</div>
                    </div>
                    <div class="env-actions">
                        <button class="btn btn-small btn-primary" onclick="activateEnvironment('${env.name}')">Activate</button>
                        <button class="btn btn-small btn-secondary" onclick="openEnvironment('${env.name}')">Open</button>
                    </div>
                </div>
            `).join('');
        }

        function showFallbackData() {
            // Show fallback data when real data can't be loaded
            currentEnvironment = {
                name: 'manim_studio_default',
                path: '~/.manim_studio/venvs/manim_studio_default',
                pythonPath: 'python',
                active: true
            };
            
            availableEnvironments = [currentEnvironment];
            installedPackages = [
                { name: 'manim', version: '0.18.0' },
                { name: 'numpy', version: '1.24.3' },
                { name: 'pillow', version: '10.0.0' }
            ];
            
            updateEnvironmentStatus();
            updateEnvironmentList();
            renderPackages();
            addLog('Using fallback environment data', 'warning');
        }

        async function installEssentialPackages() {
            const essentials = ['manim', 'numpy', 'pillow', 'matplotlib'];
            
            for (const pkg of essentials) {
                addLog(`Installing ${pkg}...`, 'info');
                // In a real implementation, this would install each package
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            await loadPackages();
            showNotification('Essential packages installed', 'success');
        }

        function activateEnvironment(envName) {
            currentEnvironment = envName;
            updateEnvironmentStatus();
            addLog(`Activated environment: ${envName}`, 'success');
            showNotification(`Environment '${envName}' activated`, 'success');
        }

        function openEnvironment(envName) {
            addLog(`Opening environment: ${envName}`, 'info');
            if (window.electronAPI && window.electronAPI.openFolder) {
                const envPath = `~/.manim_studio/venvs/${envName}`;
                window.electronAPI.openFolder(envPath);
            }
        }

        async function createEnvironment() {
            const nameInput = document.getElementById('new-env-name');
            const versionSelect = document.getElementById('python-version');
            
            const envName = nameInput.value.trim();
            const pythonVersion = versionSelect.value;

            if (!envName) {
                showNotification('Please enter an environment name', 'error');
                return;
            }

            addLog(`Creating environment: ${envName} with Python ${pythonVersion}`, 'info');
            showNotification('Creating environment...', 'info');

            try {
                // Simulate environment creation
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                availableEnvironments.push(envName);
                addLog(`Environment '${envName}' created successfully`, 'success');
                showNotification(`Environment '${envName}' created successfully`, 'success');
                
                nameInput.value = '';
                loadEnvironmentList();
            } catch (error) {
                addLog(`Failed to create environment: ${error.message}`, 'error');
                showNotification('Failed to create environment', 'error');
            }
        }

        // Package management
        async function loadPackages() {
            const packagesGrid = document.getElementById('packages-grid');
            
            if (!currentEnvironment) {
                packagesGrid.innerHTML = `
                    <div class="package-item">
                        <div class="package-name">No Environment Available</div>
                        <div class="package-version">Cannot detect packages without Python environment</div>
                        <div class="package-actions">
                            <button class="btn btn-small btn-primary" onclick="autoSetup()">Auto Setup</button>
                        </div>
                    </div>
                `;
                return;
            }

            // Show loading state
            packagesGrid.innerHTML = `
                <div class="package-item">
                    <div class="package-name">Loading packages...</div>
                    <div class="package-version">Scanning ${currentEnvironment.name}...</div>
                    <div class="package-actions">
                        <div class="spinner" style="width: 16px; height: 16px;"></div>
                    </div>
                </div>
            `;

            try {
                let packagesLoaded = false;
                let pythonCmd = currentEnvironment.pythonPath || 'python';

                if (window.electronAPI && window.electronAPI.executeCommand) {
                    const commands = [
                        `"${pythonCmd}" -m pip list --format=json`,
                        `${pythonCmd} -m pip list --format=json`,
                        `pip list --format=json`,
                        `"${pythonCmd}" -m pip list --format=freeze`,
                        `${pythonCmd} -m pip list --format=freeze`,
                        `pip list --format=freeze`,
                        `"${pythonCmd}" -m pip list`,
                        `${pythonCmd} -m pip list`,
                        `pip list`
                    ];
                    
                    for (const cmd of commands) {
                        try {
                            addLog(`Trying: ${cmd}`, 'info');
                            const result = await window.electronAPI.executeCommand(cmd);
                            
                            if (result.success && result.output && result.output.trim()) {
                                const output = result.output.trim();
                                
                                if (cmd.includes('--format=json')) {
                                    try {
                                        installedPackages = JSON.parse(output);
                                        if (installedPackages.length > 0) {
                                            packagesLoaded = true;
                                            addLog(`✅ Loaded ${installedPackages.length} packages via JSON format`, 'success');
                                            break;
                                        }
                                    } catch (jsonError) {
                                        addLog('JSON parsing failed, trying next method', 'warning');
                                        continue;
                                    }
                                } else if (cmd.includes('--format=freeze')) {
                                    const lines = output.split('\n');
                                    installedPackages = lines
                                        .filter(line => line.includes('==') && !line.startsWith('#'))
                                        .map(line => {
                                            const [name, version] = line.split('==');
                                            return { name: name.trim(), version: version.trim() };
                                        });
                                    
                                    if (installedPackages.length > 0) {
                                        packagesLoaded = true;
                                        addLog(`✅ Loaded ${installedPackages.length} packages via freeze format`, 'success');
                                        break;
                                    }
                                } else {
                                    const lines = output.split('\n');
                                    const dataLines = lines.slice(2).filter(line => 
                                        line.trim() && 
                                        !line.startsWith('-') && 
                                        !line.startsWith('Package') &&
                                        !line.startsWith('===')
                                    );
                                    
                                    installedPackages = dataLines.map(line => {
                                        const parts = line.trim().split(/\s+/);
                                        return { 
                                            name: parts[0] || 'unknown', 
                                            version: parts[1] || 'unknown' 
                                        };
                                    }).filter(pkg => pkg.name !== 'unknown');
                                    
                                    if (installedPackages.length > 0) {
                                        packagesLoaded = true;
                                        addLog(`✅ Loaded ${installedPackages.length} packages via standard format`, 'success');
                                        break;
                                    }
                                }
                            }
                        } catch (cmdError) {
                            addLog(`Command "${cmd}" failed: ${cmdError.message}`, 'warning');
                            continue;
                        }
                    }
                }
                
                if (!packagesLoaded) {
                    addLog('❌ Could not detect packages - pip may not be working', 'error');
                    packagesGrid.innerHTML = `
                        <div class="package-item">
                            <div class="package-name">Cannot detect packages</div>
                            <div class="package-version">pip command not working in ${currentEnvironment.name}</div>
                            <div class="package-actions">
                                <button class="btn btn-small btn-primary" onclick="autoSetup()">Auto Setup</button>
                                <button class="btn btn-small btn-secondary" onclick="refreshPackages()">Retry</button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                renderPackages();
                updateCurrentEnvironmentInfo(); // Update the package count
                
            } catch (error) {
                addLog(`❌ Error loading packages: ${error.message}`, 'error');
                packagesGrid.innerHTML = `
                    <div class="package-item">
                        <div class="package-name">Error loading packages</div>
                        <div class="package-version">${error.message}</div>
                        <div class="package-actions">
                            <button class="btn btn-small btn-secondary" onclick="refreshPackages()">Retry</button>
                        </div>
                    </div>
                `;
            }
        }

        function renderPackages() {
            const packagesGrid = document.getElementById('packages-grid');
            
            if (installedPackages.length === 0) {
                packagesGrid.innerHTML = `
                    <div class="package-item">
                        <div class="package-name">No Packages Installed</div>
                        <div class="package-version">Install packages to get started</div>
                        <div class="package-actions">
                            <button class="btn btn-small btn-success" onclick="installEssentialPackages()">Install Essentials</button>
                        </div>
                    </div>
                `;
                return;
            }
            
            packagesGrid.innerHTML = installedPackages.map(pkg => `
                <div class="package-item">
                    <div class="package-name">${pkg.name}</div>
                    <div class="package-version">v${pkg.version}</div>
                    <div class="package-actions">
                        <button class="btn btn-small btn-primary" onclick="updatePackage('${pkg.name}')">Update</button>
                        <button class="btn btn-small btn-danger" onclick="removePackage('${pkg.name}')">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function showFallbackPackages() {
            // Show some common packages as fallback
            installedPackages = [
                { name: 'manim', version: '0.18.0' },
                { name: 'numpy', version: '1.24.3' },
                { name: 'pillow', version: '10.0.0' }
            ];
            renderPackages();
            addLog('Showing fallback package list', 'warning');
        }

        async function installPackage() {
            const input = document.getElementById('install-input');
            const packageName = input.value.trim();

            if (!packageName) {
                showNotification('Please enter a package name', 'error');
                return;
            }

            if (!currentEnvironment) {
                showNotification('No environment active', 'error');
                return;
            }

            addLog(`Installing package: ${packageName}`, 'info');
            showNotification(`Installing ${packageName}...`, 'info');

            try {
                if (window.electronAPI && window.electronAPI.executeCommand) {
                    const pythonPath = currentEnvironment.pythonPath || 'python';
                    const command = `"${pythonPath}" -m pip install ${packageName}`;
                    
                    const result = await window.electronAPI.executeCommand(command);
                    
                    if (result.success) {
                        addLog(`Package '${packageName}' installed successfully`, 'success');
                        showNotification(`Package '${packageName}' installed successfully`, 'success');
                        
                        // Reload packages to show the new installation
                        await loadPackages();
                        input.value = '';
                    } else {
                        const errorMsg = result.error || 'Installation failed';
                        addLog(`Failed to install ${packageName}: ${errorMsg}`, 'error');
                        showNotification(`Failed to install ${packageName}`, 'error');
                    }
                } else {
                    // Simulate installation for standalone mode
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const newPackage = {
                        name: packageName,
                        version: '1.0.0'
                    };

                    installedPackages.push(newPackage);
                    renderPackages();

                    addLog(`Package '${packageName}' installed successfully (simulated)`, 'success');
                    showNotification(`Package '${packageName}' installed successfully`, 'success');
                    input.value = '';
                }
            } catch (error) {
                addLog(`Failed to install package: ${error.message}`, 'error');
                showNotification('Package installation failed', 'error');
            }
        }

        async function updatePackage(packageName) {
            addLog(`Updating package: ${packageName}`, 'info');
            showNotification(`Updating ${packageName}...`, 'info');

            try {
                await new Promise(resolve => setTimeout(resolve, 2000));
                addLog(`Package '${packageName}' updated successfully`, 'success');
                showNotification(`Package '${packageName}' updated`, 'success');
            } catch (error) {
                addLog(`Failed to update package: ${error.message}`, 'error');
                showNotification('Package update failed', 'error');
            }
        }

        async function removePackage(packageName) {
            if (!confirm(`Are you sure you want to remove '${packageName}'?`)) {
                return;
            }

            addLog(`Removing package: ${packageName}`, 'info');
            showNotification(`Removing ${packageName}...`, 'info');

            try {
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                installedPackages = installedPackages.filter(pkg => pkg.name !== packageName);
                loadPackages();

                addLog(`Package '${packageName}' removed successfully`, 'success');
                showNotification(`Package '${packageName}' removed`, 'success');
            } catch (error) {
                addLog(`Failed to remove package: ${error.message}`, 'error');
                showNotification('Package removal failed', 'error');
            }
        }

        // Health check
        function runHealthCheck() {
            addLog('Running health check...', 'info');
            
            setTimeout(() => {
                addLog('Health check completed - 3/4 checks passed', 'success');
            }, 1000);
        }

        // Environment operations
        async function refreshEnvironments() {
            addLog('Refreshing environment data...', 'info');
            showNotification('Refreshing environments...', 'info');
            
            try {
                await checkCurrentEnvironment();
                await loadAvailableEnvironments();
                await loadPackages(); // Force reload packages
                runHealthCheck();
                addLog('Environment data refreshed successfully', 'success');
                showNotification('Environment data refreshed', 'success');
            } catch (error) {
                addLog(`Refresh failed: ${error.message}`, 'error');
                showNotification('Refresh failed', 'error');
            }
        }

        // Force refresh packages specifically
        async function refreshPackages() {
            addLog('Force refreshing packages...', 'info');
            showNotification('Refreshing packages...', 'info');
            
            // Clear current packages
            installedPackages = [];
            
            // Force reload
            await loadPackages();
            
            showNotification('Packages refreshed', 'success');
        }

        async function autoSetup() {
            addLog('Starting automatic environment setup...', 'info');
            showNotification('Setting up environment...', 'info');
            
            try {
                addLog('Installing essential packages...', 'info');
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                const essentialPackages = [
                    { name: 'manim', version: '0.18.0' },
                    { name: 'numpy', version: '1.24.3' },
                    { name: 'matplotlib', version: '3.7.2' }
                ];

                essentialPackages.forEach(pkg => {
                    if (!installedPackages.find(p => p.name === pkg.name)) {
                        installedPackages.push(pkg);
                    }
                });

                loadPackages();
                addLog('Auto setup completed successfully', 'success');
                showNotification('Auto setup completed', 'success');
            } catch (error) {
                addLog(`Auto setup failed: ${error.message}`, 'error');
                showNotification('Auto setup failed', 'error');
            }
        }

        // Logging
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('terminal-log');
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#c5282f' : type === 'success' ? '#16825d' : '#0e639c'};
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 1000;
                font-size: 13px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 400px;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch (e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshEnvironments();
                        break;
                    case 'Enter':
                        if (document.activeElement.id === 'install-input') {
                            e.preventDefault();
                            installPackage();
                        } else if (document.activeElement.id === 'new-env-name') {
                            e.preventDefault();
                            createEnvironment();
                        }
                        break;
                }
            }
        });

        // Setup install input enter key
        document.getElementById('install-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                installPackage();
            }
        });

        document.getElementById('new-env-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                createEnvironment();
            }
        });
    </script>
</body>
</html>